import fs from "node:fs";
import path from "node:path";
import YAML from "yaml";

import { OPENCLAW_DNS_RESOLVER_IP, OPENCLAW_NETWORK_SUBNET } from "./constants";
import { ProfileConfig } from "./profile-schema";
const DNS_UPSTREAM_SERVERS = ["1.1.1.1", "8.8.8.8"];

function normalizedAllowlist(profile: ProfileConfig): string[] {
  return [...new Set(profile.network.allow.map((domain) => domain.toLowerCase()))];
}

function buildDnsmasqConfig(profile: ProfileConfig): string {
  const allowlist = normalizedAllowlist(profile);
  const lines = [
    "# Generated by ocs install. Do not edit manually.",
    "port=53",
    "no-resolv",
    "no-hosts",
    "domain-needed",
    "bogus-priv",
    "bind-interfaces",
    "listen-address=0.0.0.0",
    "cache-size=0"
  ];

  for (const domain of allowlist) {
    for (const upstream of DNS_UPSTREAM_SERVERS) {
      lines.push(`server=/${domain}/${upstream}`);
    }
  }

  return `${lines.join("\n")}\n`;
}

function buildCompose(profileName: string, profile: ProfileConfig): string {
  const dnsAllowlistService = {
    image: "alpine:3.20",
    restart: "unless-stopped",
    command: [
      "sh",
      "-ec",
      "apk add --no-cache dnsmasq >/dev/null && exec dnsmasq --keep-in-foreground --conf-file=/etc/dnsmasq.conf --log-facility=-"
    ],
    volumes: ["./dnsmasq.conf:/etc/dnsmasq.conf:ro"],
    networks: {
      openclaw_net: {
        ipv4_address: OPENCLAW_DNS_RESOLVER_IP
      }
    }
  };

  const openclawService: Record<string, unknown> = {
    image: "nicolaka/netshoot:latest",
    restart: "unless-stopped",
    command: ["sleep", "infinity"],
    user: "65532:65532",
    volumes: ["./openclaw.config.json:/etc/openclaw/config.json:ro"],
    networks: ["openclaw_net"],
    depends_on: ["dns_allowlist"],
    dns: [OPENCLAW_DNS_RESOLVER_IP]
  };

  if (profile.openclaw.webui.enabled) {
    openclawService.ports = ["127.0.0.1:3000:3000"];
  }

  const compose = {
    name: `openclaw-${profileName}`,
    services: {
      dns_allowlist: dnsAllowlistService,
      openclaw: openclawService
    },
    networks: {
      openclaw_net: {
        name: "openclaw_net",
        driver: "bridge",
        ipam: {
          config: [{ subnet: OPENCLAW_NETWORK_SUBNET }]
        }
      }
    }
  };

  return YAML.stringify(compose);
}

function buildSnapperOverlay(profileName: string): string {
  const overlay = {
    name: `openclaw-${profileName}`,
    services: {
      snapper: {
        image: "ghcr.io/openclaw/snapper:latest",
        restart: "unless-stopped",
        networks: ["openclaw_net"]
      },
      openclaw: {
        depends_on: ["snapper"],
        environment: {
          OPENCLAW_TOOL_PROXY_PROVIDER: "snapper",
          OPENCLAW_TOOL_PROXY_URL: "http://snapper:8080"
        }
      }
    }
  };

  return YAML.stringify(overlay);
}

function buildReadme(profileName: string, profile: ProfileConfig): string {
  const allowlist = normalizedAllowlist(profile);
  const allowedDomainExample = allowlist[0] ?? "localhost";
  const blockedDomainExample = allowlist.includes("example.com") ? "iana.org" : "example.com";
  const webUiStatus = profile.openclaw.webui.enabled
    ? "Enabled and bound to localhost only (`127.0.0.1:3000`)."
    : "Disabled by default (no public port exposure).";
  const snapperRunCommand = profile.snapper.enabled
    ? "docker compose -f docker-compose.yml -f docker-compose.snapper.yml up -d"
    : "docker compose up -d";
  const snapperFilesLine = profile.snapper.enabled
    ? "- `docker-compose.snapper.yml` Optional Snapper overlay (enabled for this profile)"
    : "";
  const snapperSection = profile.snapper.enabled
    ? `## Snapper module
Snapper is enabled for this profile.

Use the overlay when starting services:

\`\`\`bash
docker compose -f docker-compose.yml -f docker-compose.snapper.yml up -d
\`\`\`

Best-effort routing: the overlay sets \`OPENCLAW_TOOL_PROXY_PROVIDER=snapper\` and
\`OPENCLAW_TOOL_PROXY_URL=http://snapper:8080\` on the \`openclaw\` service.
If the OpenClaw runtime supports these settings, tool calls are routed via Snapper.
`
    : `## Snapper module
Snapper is disabled for this profile.

Set \`snapper.enabled: true\` in the profile and re-run install to generate a Snapper overlay.
`;

  return `# ${profileName} deployment output

This folder is generated by \`ocs install --profile ${profileName}\`.

## Files
- \`docker-compose.yml\` Compose definition with dedicated network \`openclaw_net\`
- \`openclaw.config.json\` Normalized OpenClaw config rendered from profile input
- \`dnsmasq.conf\` DNS allowlist resolver configuration for \`dns_allowlist\`
${snapperFilesLine}

## Run
\`\`\`bash
${snapperRunCommand}
\`\`\`

## DNS allowlist
- \`dns_allowlist\` is enabled by default for all profiles.
- \`openclaw\` only uses resolver \`${OPENCLAW_DNS_RESOLVER_IP}\`.
- Allowed domains: ${allowlist.length > 0 ? allowlist.map((domain) => `\`${domain}\``).join(", ") : "(none)"}

Validation commands:

\`\`\`bash
docker compose exec -T openclaw nslookup ${allowedDomainExample}
docker compose exec -T openclaw nslookup ${blockedDomainExample}
\`\`\`

Expected: allowlisted lookup succeeds; non-allowlisted lookup fails.

## Host firewall
Apply deny-by-default egress enforcement:

\`\`\`bash
sudo node dist/ocs.js apply-firewall --profile ${profileName}
\`\`\`

Rollback host firewall rules:

\`\`\`bash
sudo node dist/ocs.js rollback-firewall
\`\`\`

Ticket 4 verification commands:

\`\`\`bash
docker compose exec -T openclaw curl -I --max-time 10 https://${allowedDomainExample}
docker compose exec -T openclaw curl -I --max-time 10 https://example.com
\`\`\`

${snapperSection}

## Web UI exposure
${webUiStatus}

To enable Web UI access for local machine only, set:

\`\`\`yaml
openclaw:
  webui:
    enabled: true
\`\`\`

Then re-run:

\`\`\`bash
node dist/ocs.js install --profile ${profileName}
\`\`\`
`;
}

export function writeInstallArtifacts(profileName: string, profile: ProfileConfig): string {
  const outDir = path.resolve(process.cwd(), "out", profileName);
  const snapperOverlayPath = path.join(outDir, "docker-compose.snapper.yml");

  fs.mkdirSync(outDir, { recursive: true });
  fs.writeFileSync(path.join(outDir, "docker-compose.yml"), buildCompose(profileName, profile), "utf8");
  fs.writeFileSync(path.join(outDir, "openclaw.config.json"), `${JSON.stringify(profile, null, 2)}\n`, "utf8");
  fs.writeFileSync(path.join(outDir, "dnsmasq.conf"), buildDnsmasqConfig(profile), "utf8");
  if (profile.snapper.enabled) {
    fs.writeFileSync(snapperOverlayPath, buildSnapperOverlay(profileName), "utf8");
  } else if (fs.existsSync(snapperOverlayPath)) {
    fs.unlinkSync(snapperOverlayPath);
  }
  fs.writeFileSync(path.join(outDir, "README.md"), buildReadme(profileName, profile), "utf8");

  return outDir;
}
